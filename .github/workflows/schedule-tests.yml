# GitHub Actions workflow: Scheduled Selenium Tests on Windows with Chrome 142
on:
  # Run every day at 1:30 AM IST (UTC 11:55)
  schedule:
    - cron: "55 11 * * *"
  workflow_dispatch:

name: Scheduled Selenium Tests (Windows + Chrome 142)

jobs:
  run-tests:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Install Google Chrome 142 (if you provide an MSI URL)
        shell: pwsh
        env:
          # Optional secret: set CHROME_142_MSI_URL to a direct MSI URL for the exact Chrome 142 build
          CHROME_142_MSI_URL: ${{ secrets.CHROME_142_MSI_URL }}
        run: |
          choco feature enable -n allowGlobalConfirmation
          Write-Host "Attempting to install google-chrome via Chocolatey (may not be version 142)..."
          try {
            choco install googlechrome -y --no-progress
          } catch {
            Write-Host "choco install googlechrome failed or no network; continuing to MSI fallback if provided."
          }

          if ($env:CHROME_142_MSI_URL) {
            Write-Host "CHROME_142_MSI_URL provided; downloading & installing the specified MSI..."
            $msiFile = Join-Path $PWD 'chrome142.msi'
            Invoke-WebRequest -Uri $env:CHROME_142_MSI_URL -OutFile $msiFile
            Start-Process msiexec.exe -ArgumentList '/i', $msiFile, '/qn', '/norestart' -Wait
            Write-Host "MSI install completed."
          } else {
            Write-Host "No CHROME_142_MSI_URL provided. The runner's installed Chrome may not be v142."
            Write-Host "If you need the exact Chrome 142 binary, set a repository secret named CHROME_142_MSI_URL with a direct MSI URL."
          }

      - name: Install matching ChromeDriver for Chrome 142
        shell: pwsh
        run: |
          $major = '142'
          Write-Host "Resolving chromedriver for major version $major..."
          $version = Invoke-RestMethod -Uri "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$major"
          Write-Host "Resolved ChromeDriver version: $version"
          $zipUrl = "https://chromedriver.storage.googleapis.com/$version/chromedriver_win32.zip"
          $out = "$PWD\chromedriver.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile $out
          Expand-Archive -Path $out -DestinationPath 'C:\chromedriver' -Force
          # Add to PATH for the remainder of the job
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\chromedriver'
          Write-Host "ChromeDriver installed to C:\chromedriver and added to PATH."

      - name: Verify Chrome & ChromeDriver versions
        shell: pwsh
        run: |
          $chromePaths = @(
            'C:\Program Files\Google\Chrome\Application\chrome.exe',
            'C:\Program Files (x86)\Google\Chrome\Application\chrome.exe'
          ) | Where-Object { Test-Path $_ }
          if ($chromePaths.Count -gt 0) {
            Write-Host "Chrome found at: $($chromePaths[0])"
            (Get-Item $chromePaths[0]).VersionInfo.ProductVersion
          } else {
            Write-Host "Chrome executable not found in standard locations. If you installed a custom MSI, locate it below (first 10 matches):"
            Get-ChildItem 'C:\' -Filter chrome.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 10 | ForEach-Object { $_.FullName }
          }

          Write-Host "Chromedriver version:"
          & 'C:\chromedriver\chromedriver.exe' --version

      - name: Clean & Run Tests
        shell: pwsh
        env:
          # Provide the chromedriver path to your test framework if needed
          WEBDRIVER_CHROME_DRIVER: C:\chromedriver\chromedriver.exe
          # Optional: point CHROME_BIN to the chrome.exe path if your test code reads it
          CHROME_BIN: 'C:\Program Files\Google\Chrome\Application\chrome.exe'
        run: |
          Write-Host "Running mvn tests..."
          mvn clean test -DsuiteXmlFile=TestNGxmls/Grouping.xml -DchromeOptions.args="--headless"

      - name: Upload TestNG Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-reports
          path: |
            test-output/
            target/surefire-reports/
